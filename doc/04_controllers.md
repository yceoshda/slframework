# Controller

Controllers are where all the real code reside., data access is to be handled by models, visualisation belongs to views, but crunching numbers and all has to be done somewhere: controllers.

Every controller should (must!!!) inherit from 'spacelife\core\Controller'. And you should **not** overload the '__construct' method (or anyother existing method for that matter). That being said, Controller as a lot of specifically tailored injectors and tools to help you.

## Basics

Controllers automatically load the configuration, set the language to be used, give access to data being posted (or sent via the URI), verify the session and basic ACLs, autoloads models and translations, handles caching ...

A lot of it is directly dependant on the properties and executed in the constructor.

## Properties

There are a few properties that should be overloaded when creating a controller. This will get you all the tools you need to properly use the SL Framework.

Some of these properties should be directly overloaded, others should use a setter.

### Layout ('layout')

This property determines the layout that will be used in the final render (the one that sends the page to the browser).

Use the setter 'setLayout' for more convenience.

There is another similar property that can be directly overloaded (because its not that ofter that you'll need it): 'admin_layout'. It is used only to render admin pages.

A layout should have sort of an absolute path (relatively to the 'views/' folder), meaning it should start with a '/'.

```php

protected $layout = '/layout/myLayout';

```

### Templates ('template_dir')

Use this property to specify in which directory (inside 'views/') your templates will be stored. this will be used to autoload them using the 'loadTemplate' (or 'template' in short) method.

### Models

To access data you should (must??!) always use models. Sometimes you'll want one or more models to always be loaded for your controller, so to avoid systematically calling the injector 'loadModel' you can specify a list (array) of models to always be loaded when instanciating your controller.

On top of it you'll need to specify from which namespace these should be loaded.

#### Namespace ('modelNS')

You should define this property to the namespace of your models to be used for this controller.

```php

protected $modelNS = 'model\namespace\forthiscontroller';

```

#### Auto-injector ('models')

This property should be a simple array of models to load.

```php

//  autoload the models for users and fruits.
protected $models = ['Users', 'Fruits'];

```

### Content variables ('content_vars')

This property is an array, each element should be accessed using it's setter.

#### Title

This will be the title of the page (title of the browser window: head>title).

```php

$this->setTitle('My super page');

```

#### JS

This allow adding custom JavaScripts to a page generated by this controller.

```php

$this->addJS('myjsfile');
$this->addJS('myotherjsfile');

```

#### CSS

Same as JavaScript, use this to inject CSS in a page from this controller.

```php

$this->addCSS('mycss');
$this->addCSS('myothercss');

```

#### Content

This will be the content of the page added to the layout. It should always be called at the end of a the controller method being executed...

It can be combined to the templating engine.

```php

//  do some amazing stuff
//  and more

//  create template
$tpl = $this->template('myPage');
$tpl->set('var', $myvar);

//  sending it to the final render
$this->setContent($tpl->render());

```

### Translations

The entire framework has been designed to handle multilang from the beginning. There is more info on the translation mecanism in the designated topic, but basically this is using json files that have to be loaded in the controller to be used. Like models, it can be very boring to always begin a controller method with a 'loadTranslation' ... So there is an auto-injector !

#### Directory ('translation_path')

First you need to tell the controller where your translation files will be located. If not it will use the default location from the configuration ('vendor/spacelife/translation').

```php

protected $translation_path = 'path/to/your/translations';

```

#### Auto-injector ('translate') + ('translate_admin')

As said before, you can specify a list of translations to be loaded for every pages (there is also a specific list for admin pages that can be auto-loaded only in the admin context, this is working the exact same way). Remember the 'translation_path' property will be used to locate the files. Translations are injected inside the 'T' property in the controller.

Admin translations are not overwriting regular ones, this just loads more!

```php

//  load these for regular pages (like models, we want user and fruit translations)
protected $translate = ['user', 'fruit'];

//  load also this if we are on an admin page
protected $translate_admin = ['admin_user', 'admin_fruit'];

//  accessible via
$this->T->fruit;

```

#### Layouts translations

Sometimes you need a specific translation for the final layout.

```php

protected $translate_layout = 'mylayout';
protected $translate_layout_dir = 'mydir';

```


## Tools

There are a few tools that are automatically setted for every controller.

### Get data

Data from GET is loaded into '$this->request->uri'.

This is actually part of the request module.

### Post data

Data from POST is automatically loaded into '$this->request->data'.

This is actually also part of the request module.

### Configuration

The global configuration is loaded automatically in '$this->config'.

For more info on configuration mecanism, please read the Configuration topic.

### Session

Sessions are automatically handled (with spacelife\core\Session). And they are loaded in '$this->session'.

For more info about sessions, please read the sessions topic.

Notifications are part of the session module. the controller method 'notify' allows for notification to be added to the rendering scope for the final render, this is automatic, no need to worry about it!

### Cache

A cache object is automatically loaded in the controller (as it is used for configuration and translations by default). It can be used via '$this->cache->method()'.

For more info on caching mecanism, please refer to the Cache topic.

### Languages

Language is automatically set when initializing the controller. It uses a priority order, when something matches it immediatly ends the "search".

-   Lang is requested in url?
-   Lang is in session?
-   Lang can be retrieved from browser request headers?
-   Use lang from 'default_lang' in config.

Of course, language is compared against the list of available languages, if it does not exists it defaults back to config default.

### Redirect

If for some reason you need to redirect a page to another you can use the 'redirect' method.

```php

//  basic redirect
$this->redirect('my/url');

//  redirect with code
$this->redirect('other/url', 301);

//  404 redirection (parameters should be in a translation file: e404)
$this->e404('notfound');

```

## Runtime Injectors

There should always be an injector when you need it!

SL Framework provides a few of them to simplify your work.

### Models

You should never instanciate a model by yourself (as models constructor can require very specific data).

Use the 'loadModel' injection method to load it into your controller. Of course it relies on the 'modelNS' property to find it (alternatively you can specify a second parameter to 'loadModel' being the namespace to be used). The model will then be directly accessible by it's name.

```php

//  normal loading
$this->loadModel('Users');

//  now accessible via
$this->Users->method();

//  load with specific NS
$this->loadModel('Apples', 'fruits\models');

//  also accessible via
$this->Apples->method();

```

### Templates

When you need to use a template (also called view!). You should use 'loadTemplate' (or 'template' for short). This will automatically find the right file (based on 'template_dir' property) with the correct language. It will return the template as an object.

```php

//  load myview
$tpl = $this->template('myview');

```

### Translations

Translations are json files, same as views they can be loacalized. When loading them with 'loadTranslation' the language will be automatically selected. Translations are injected in the 'T' property of the controller.

```php

//  load banana translation
$this->loadTranslation('banana');

//  now accessible via
$this->T->banana;

```

### Forms

Forms are a strange case, it's a helper, but there are to much dependancies to be used as such. They must be loaded from the controller. The loader returns an object (as for templates). To create it you need to give it data (used to pre-fill fields, but can be empty), errors (being the validation_errors from a model, but can be empty) and the translation scope (as loaded with loadTranslation or the autoloader)

```php

//  data from the POST
$data = $this->request->data;

//  errors from the model validation
$errors = $this->Fruits->validation_errors;

//  create a form
$form = $this->createForm($data, $errors, 'fruit');

```

